<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Payroll">
<title>Payroll App</title>

<style>
/* =====================
   BASE
===================== */
body{
  font-family:-apple-system,BlinkMacSystemFont,Arial,sans-serif;
  margin:0;
  background:#f2f2f7;
  color:#333;
}

select,input{
  padding:6px 8px;
  border-radius:8px;
  border:1px solid #ccc;
}

/* =====================
   HEADER
===================== */
.header{
  position:sticky;
  top:0;
  background:#fff;
  padding:12px;
  border-bottom:1px solid #ddd;
  z-index:10;
}

.header h2{
  margin:0 0 8px;
}

.filters{
  display:flex;
  gap:8px;
}

/* =====================
   CALENDAR
===================== */
.calendar{
  padding:10px;
}

.weekdays,.days{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  text-align:center;
}

.weekdays div{
  font-size:12px;
  font-weight:bold;
  color:#666;
}

.day{
  background:#fff;
  border-radius:10px;
  margin:4px;
  padding:10px 0;
  cursor:pointer;
  position:relative;
}

.day.selected{
  background:#1976d2;
  color:#fff;
}

/* จุดสถานะ */
.day.has-work::after,
.day.has-holiday::after,
.day.has-leave::after,
.day.has-absent::after{
  content:"";
  width:6px;
  height:6px;
  border-radius:50%;
  position:absolute;
  bottom:4px;
  left:50%;
  transform:translateX(-50%);
}

.day.has-work::after{background:#4caf50;}
.day.has-holiday::after{background:#2196f3;}
.day.has-leave::after{background:#ff9800;}
.day.has-absent::after{background:#e53935;}

/* =====================
   BOTTOM SHEET
===================== */
#cardWrapper{
  position:fixed;
  left:0;
  right:0;
  bottom:0;
  height:90vh;
  background:#f2f2f7;
  border-top-left-radius:18px;
  border-top-right-radius:18px;
  box-shadow:0 -4px 20px rgba(0,0,0,.15);
  transform:translateY(100%);
  transition:.35s cubic-bezier(.25,.8,.25,1);
  overflow-y:auto;
  padding:12px;
  z-index:20;
}

#cardWrapper.hidden{transform:translateY(100%);}
#cardWrapper.half{transform:translateY(45%);}
#cardWrapper.full{transform:translateY(0);}

.sheet-handle{
  width:40px;
  height:5px;
  background:#ccc;
  border-radius:3px;
  margin:6px auto 10px;
}

/* =====================
   CARD (เดิม)
===================== */
.card{
  background:#fff;
  border-radius:14px;
  padding:12px;
  margin-bottom:14px;
  box-shadow:0 2px 6px rgba(0,0,0,.08);
}

.card-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:12px;
}

.card.collapsed .card-body{display:none}

.badge{
  padding:2px 8px;
  border-radius:10px;
  font-size:12px;
  font-weight:bold;
  color:#fff;
}

.badge-work{background:#4caf50}
.badge-holiday{background:#607d8b}
.badge-leave{background:#ff9800}
.badge-absent{background:#e53935}

.row{
  display:flex;
  align-items:center;
  margin-bottom:8px;
}

.row label{
  width:70px;
  font-weight:bold;
  color:#555;
}

.row select{flex:1}

button.small{
  padding:4px 8px;
  font-size:12px;
  border:none;
  border-radius:8px;
}

/* =====================
   RESULT
===================== */
#result{
  background:#fff;
  border-radius:14px;
  padding:14px;
  margin-top:16px;
}

.result-row{
  display:grid;
  grid-template-columns:1fr 120px 120px;
  gap:8px;
  font-size:14px;
}

.result-net{
  background:#0b4f0c;
  color:#fff;
  padding:12px;
  border-radius:12px;
  display:flex;
  justify-content:space-between;
  font-size:22px;
}
</style>
</head>

<body>

<header class="header">
  <h2>งวดจ่าย</h2>
  <div class="filters">
    <select id="monthSelect"></select>
    <select id="yearSelect"></select>
  </div>
</header>

<section class="calendar">
  <div class="weekdays">
    <div>อา</div><div>จ</div><div>อ</div><div>พ</div><div>พฤ</div><div>ศ</div><div>ส</div>
  </div>
  <div class="days" id="calendarDays"></div>
</section>

<div id="cardWrapper" class="hidden">
  <div class="sheet-handle"></div>
  <div id="cardContainer"></div>
  <div id="result"></div>
</div>

<script>
/* =====================
   DATE & MONTH
===================== */
const daysTH=["อาทิตย์","จันทร์","อังคาร","พุธ","พฤหัสบดี","ศุกร์","เสาร์"];
const monthNames=["มกราคม","กุมภาพันธ์","มีนาคม","เมษายน","พฤษภาคม","มิถุนายน",
"กรกฎาคม","สิงหาคม","กันยายน","ตุลาคม","พฤศจิกายน","ธันวาคม"];

const monthSelect=document.getElementById("monthSelect");
const yearSelect=document.getElementById("yearSelect");

monthNames.forEach((m,i)=>{
  const o=document.createElement("option");
  o.value=i;o.textContent=m;
  monthSelect.appendChild(o);
});

const now=new Date();
for(let y=now.getFullYear()-1;y<=now.getFullYear()+1;y++){
  const o=document.createElement("option");
  o.value=y;o.textContent=y;
  yearSelect.appendChild(o);
}

monthSelect.value=now.getMonth();
yearSelect.value=now.getFullYear();

function formatLocalDate(d){
  return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0");
}

/* =====================
   STORAGE
===================== */
function getMonthKey(){
  return `payroll-${yearSelect.value}-${monthSelect.value}`;
}

function loadCards(){
  return JSON.parse(localStorage.getItem(getMonthKey())||"[]");
}

function saveCards(){
  const data=[...document.querySelectorAll(".card")].map(c=>({
    date:c.dataset.date,
    status:c.querySelector(".status").value,
    shift:c.querySelector(".shift").value,
    normal:c.querySelector(".normal").value,
    ot:c.querySelector(".ot").value
  }));
  localStorage.setItem(getMonthKey(),JSON.stringify(data));
}

/* =====================
   CARD
===================== */
const container=document.getElementById("cardContainer");

function updateBadge(card){
  const s=card.querySelector(".status").value;
  const b=card.querySelector(".badge");
  b.className="badge";
  if(s==="ขาดงาน")b.classList.add("badge-absent");
  else if(s.includes("ลา"))b.classList.add("badge-leave");
  else if(s.includes("หยุด"))b.classList.add("badge-holiday");
  else b.classList.add("badge-work");
  b.textContent=s;
}

function createCard(date,saved){
  const dStr=formatLocalDate(date);
  const card=document.createElement("div");
  card.className="card";
  card.dataset.date=dStr;

  card.innerHTML=`
  <div class="card-header">
    <div>${dStr} (${daysTH[date.getDay()]})</div>
    <span class="badge"></span>
  </div>
  <div class="card-body">
    <div class="row"><label>สถานะ</label>
      <select class="status">
        <option>วันทำงาน</option>
        <option>วันหยุด</option>
        <option>วันหยุดประเพณี</option>
        <option>ลาพักร้อน</option>
        <option>ลาป่วยแพทย์</option>
        <option>ลากิจพิเศษ</option>
        <option>ลาป่วย</option>
        <option>ลากิจ</option>
        <option>ขาดงาน</option>
      </select>
    </div>
    <div class="row"><label>กะ</label>
      <select class="shift"><option></option><option>เช้า</option><option>ดึก</option></select>
    </div>
    <div class="row"><label>ปกติ</label>
      <select class="normal"><option>0</option><option>4</option><option>8</option></select>
    </div>
    <div class="row"><label>โอที</label>
      <select class="ot"><option>0</option><option>0.17</option><option>2.51</option><option>4.51</option></select>
    </div>
  </div>`;

  container.appendChild(card);

  card.querySelector(".status").value=saved?.status||"วันทำงาน";
  card.querySelector(".shift").value=saved?.shift||"";
  card.querySelector(".normal").value=saved?.normal||"0";
  card.querySelector(".ot").value=saved?.ot||"0";

  updateBadge(card);

  ["status","shift","normal","ot"].forEach(c=>{
    card.querySelector("."+c).onchange=()=>{
      updateBadge(card);
      saveCards();
      renderCalendar();
    };
  });
}

/* =====================
   CALENDAR
===================== */
let selectedDate=null;

function getDayStatusMap(){
  const map={};
  loadCards().forEach(d=>{
    if(d.status==="ขาดงาน")map[d.date]="absent";
    else if(d.status.includes("ลา"))map[d.date]="leave";
    else if(d.status.includes("หยุด"))map[d.date]="holiday";
    else map[d.date]="work";
  });
  return map;
}

function renderCalendar(){
  const el=document.getElementById("calendarDays");
  el.innerHTML="";

  const y=+yearSelect.value;
  const m=+monthSelect.value;
  const start=new Date(y,m-1,16);
  const end=new Date(y,m,15);
  const statusMap=getDayStatusMap();

  for(let d=new Date(start);d<=end;d.setDate(d.getDate()+1)){
    const div=document.createElement("div");
    div.className="day";
    div.textContent=d.getDate();
    const key=formatLocalDate(d);

    if(statusMap[key])div.classList.add("has-"+statusMap[key]);

    div.onclick=()=>{
      selectedDate=key;
      document.querySelectorAll(".day").forEach(x=>x.classList.remove("selected"));
      div.classList.add("selected");
      showCard();
    };

    el.appendChild(div);
  }
}

/* =====================
   SHEET
===================== */
const sheet=document.getElementById("cardWrapper");

function openHalf(){sheet.className="half";}
function openFull(){sheet.className="full";}
function closeSheet(){sheet.className="hidden";}

function showCard(){
  document.querySelectorAll(".card").forEach(c=>{
    c.style.display=c.dataset.date===selectedDate?"block":"none";
  });
  openHalf();
}

/* =====================
   INIT
===================== */
function renderMonth(){
  container.innerHTML="";
  closeSheet();

  const y=+yearSelect.value;
  const m=+monthSelect.value;
  const start=new Date(y,m-1,16);
  const end=new Date(y,m,15);
  const saved=loadCards();
  const map={};
  saved.forEach(d=>map[d.date]=d);

  for(let d=new Date(start);d<=end;d.setDate(d.getDate()+1)){
    createCard(d,map[formatLocalDate(d)]);
  }

  renderCalendar();
}

monthSelect.onchange=renderMonth;
yearSelect.onchange=renderMonth;

renderMonth();
</script>

</body>
</html>